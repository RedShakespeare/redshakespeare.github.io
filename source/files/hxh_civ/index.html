<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HXH CIV Files</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:980px;margin:32px auto;padding:0 16px}
    .toolbar{display:flex;gap:12px;align-items:center;margin:16px 0}
    input{flex:1;padding:10px 12px;border:1px solid #ddd;border-radius:10px}
    .meta{color:#666;font-size:12px}
    ul{list-style:none;padding-left:18px;margin:6px 0}
    li{margin:6px 0}
    details{border:1px solid #eee;border-radius:12px;padding:8px 10px;background:#fafafa}
    summary{cursor:pointer;font-weight:600}
    a{color:#0b66ff;text-decoration:none}
    a:hover{text-decoration:underline}
    .row{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .size{color:#888;font-size:12px}
  </style>
</head>
<body>
  <h1>文件下载</h1>
  <div class="toolbar">
    <input id="q" placeholder="搜索文件/文件夹…" />
    <span class="meta" id="meta"></span>
  </div>
  <div id="root"></div>

<script>
  const fmtSize = (n) => {
    if (n == null) return "";
    const units = ["B","KB","MB","GB","TB"];
    let i = 0, x = n;
    while (x >= 1024 && i < units.length - 1) { x /= 1024; i++; }
    return (Math.round(x * 10) / 10) + " " + units[i];
  };

  // 把 "a/中文 file.zip" 这种相对路径，逐段 encode，保证链接可用
  const encodeRel = (rel) => rel.split("/").map(s => encodeURIComponent(s)).join("/");

  const match = (name, q) => !q || name.toLowerCase().includes(q);

  function renderNode(node, q) {
    if (node.type === "file") {
      if (!match(node.name, q)) return null;

      const li = document.createElement("li");
      const href = "./" + encodeRel(node.rel);
      li.innerHTML = `
        <div class="row">
          <a href="${href}" download>${node.name}</a>
          <span class="size">${fmtSize(node.size)}</span>
        </div>`;
      return li;
    }

    // dir
    const kids = [];
    for (const ch of (node.children || [])) {
      const el = renderNode(ch, q);
      if (el) kids.push(el);
    }
    const selfMatch = match(node.name, q);
    if (!selfMatch && kids.length === 0) return null;

    const wrap = document.createElement("div");
    const details = document.createElement("details");
    details.open = q ? true : false;

    const sum = document.createElement("summary");
    sum.textContent = node.name;

    details.appendChild(sum);

    const ul = document.createElement("ul");
    for (const k of kids) ul.appendChild(k);
    details.appendChild(ul);

    wrap.appendChild(details);
    return wrap;
  }

  async function main() {
    const res = await fetch("./tree.json", { cache: "no-store" });
    if (!res.ok) throw new Error("tree.json 加载失败");
    const data = await res.json();

    document.getElementById("meta").textContent =
      "生成时间: " + new Date(data.generatedAt).toLocaleString();

    const rootEl = document.getElementById("root");
    const qEl = document.getElementById("q");

    const doRender = () => {
      const q = (qEl.value || "").trim().toLowerCase();
      rootEl.innerHTML = "";
      const pseudoRoot = { type: "dir", name: "hxh_civ", children: data.children || [] };
      const view = renderNode(pseudoRoot, q);
      rootEl.appendChild(view || document.createTextNode("没有匹配结果"));
    };

    qEl.addEventListener("input", doRender);
    doRender();
  }

  main().catch(err => {
    document.getElementById("root").textContent = "加载失败：" + err.message;
  });
</script>
</body>
</html>
