---
title: 使用SIMH模拟器安装4.2 BSD（以Win11为例）
tags:
  - 资源
  - roguelike
  - SIMH
  - 虚拟机
  - 教程
  - 4.2 BSD
---

最近在[Archive RL S](roguelike/)写Moria的时候非常想玩一下VMS上的原版Moria，拿SIMH折腾了很久没成功（能启动VMS 2.0，但是无法在宿主机和虚拟机之间传输文件）。卡住期间顺手试了试[别的教程](https://gunkies.org/wiki/Installing_4.2_BSD_on_SIMH)，成功在SIMH的VAX-11/780虚拟机上启动了自带Rogue 5.3的4.2 BSD系统（让Rogue在1980年代风靡全美大学生的功臣之一）。在这里复述一下教程并记录安装经过。

## 文件需求

为了安装4.2 BSD，你需要准备以下文件：（所有下载文件的[zip包](files/rl/rogue/4.2bsd_pack.zip)，省得一个一个点链接）

* Perl解释器，用来制作4.2 BSD的磁带镜像；
* gzip（或者随便什么可以解压.tar.gz文件的解压工具，我用的是Bandizip）；
* boot42文件，使用Linux的uudecode命令从[boot42.uue](files/rl/rogue/4.2BSD/boot42.uue)文件中解码，或下载解码好的文件（[sourceforge](https://sourceforge.net/projects/bsd42/files/Install%20tapes/4.2%20BSD/boot42/download)/[本地镜像](files/rl/rogue/4.2BSD/boot42)）；
* 编译好的SIMH [vax780.exe](files/rl/rogue/4.2BSD/VAX780.exe)，以及SIMH [vmb.exe](files/rl/rogue/4.2BSD/vmb.exe)（不过vmb.exe全程好像都没用到？不知道有什么用……）。你也可以在[SIMH官方repo](https://github.com/simh/simh)下载自动编译的版本（vmb.exe在[src里](https://github.com/simh/simh/tree/master/VAX)，最新编译的vax780.exe文件在[Actions](https://github.com/simh/simh/actions)中任意一个run里的Artifacts里）；

也可以直接下载[制作好的4.2 BSD磁带镜像](files/rl/rogue/4.2BSD/4.2bsd.tap.bz2)，需要bzip2（或者随便什么可以解压.bz2文件的解压工具，Bandizip仍然适用）。

此外，你还需要以下4.2 BSD的目录文件（教程作者建议从[tuhs.superglobalmegacorp.com](http://tuhs.superglobalmegacorp.com/4BSD/Distributions/4.2BSD/)下载，但是这个站点目前似乎挂了，我用了时光机才下下来，非常折腾……建议直接用上面那个全套zip包）：

[ingres.tar.gz](http://tuhs.superglobalmegacorp.com/4BSD/Distributions/4.2BSD/ingres.tar.gz)
[miniroot.gz](http://tuhs.superglobalmegacorp.com/4BSD/Distributions/4.2BSD/miniroot.gz)
[new.tar.gz](http://tuhs.superglobalmegacorp.com/4BSD/Distributions/4.2BSD/new.tar.gz)
[rootdump.gz](http://tuhs.superglobalmegacorp.com/4BSD/Distributions/4.2BSD/rootdump.gz)
[src.tar.gz](http://tuhs.superglobalmegacorp.com/4BSD/Distributions/4.2BSD/src.tar.gz)
[srcsys.tar.gz](http://tuhs.superglobalmegacorp.com/4BSD/Distributions/4.2BSD/srcsys.tar.gz)
[stand.gz](http://tuhs.superglobalmegacorp.com/4BSD/Distributions/4.2BSD/stand.gz)
[usr.tar.gz](http://tuhs.superglobalmegacorp.com/4BSD/Distributions/4.2BSD/usr.tar.gz)
[vfont.tar.gz](http://tuhs.superglobalmegacorp.com/4BSD/Distributions/4.2BSD/vfont.tar.gz)



## 安装准备

### 准备4.2 BSD磁带镜像（42.tap）

**如果你安装了Perl解释器，打算自己制作4.2 BSD镜像：**

首先解压所有用来制作镜像的文件：

```
gzip -d *.gz
```

接着命令行运行[mkdisttap.pl](files/rl/rogue/4.2BSD/mkdisttap.pl)，将输出导入42.tap文件（教程提供的是Linux命令行示例，我自己运行脚本报错找不到stand，所以用的是制作好的镜像）：

```
% ./mkdisttap.pl > 42.tap
% ls -l 42.tap
-rw-r--r--  1 Neozeed  +SYSTEM  69943640 Feb  6 12:39 42.tap
```

**如果你选择信任预编译，直接使用做好的4.2 BSD镜像：**

解压4.2bsd.tap.bz2，然后将文件名改为42.tap即可。

### 准备启动程序（boot42）

解码boot42.uue文件，如果你使用解码后的boot42请无视这一步：

```
% ls -l boot42.uue
-rw-r--r--  1 Neozeed  None_ploc  9117 Feb  6 12:09 boot42.uue
% uudecode boot42.uue
% ls -l boot42
-rw-------  1 Neozeed  None_ploc  6600 Feb  6 12:28 boot42
% file boot42
boot42: data
```

## 第一阶段

在安装的第一阶段，我们需使用如下的 **install.ini** 配置文件（复制到文本文档后重命名为install.ini，也可以[直接下载](files/rl/rogue/4.2BSD/install.ini)）：

```
set rq0 ra81
at rq0 miniroot
set rq1 ra81
at rq1 rq.dsk
set rq1 dis
set rq2 dis
set rq3 dis
set rp dis
set lpt dis
set rl dis
set tq dis
set tu dis
att ts 42.tap
set tti 7b
set tto 7b
load -o boot42 0
d r10 9
d r11 0
run 2
```

### 启动虚拟机

使用 **install.ini** 启动我们的vax780.exe虚拟机。

```
C:\4.2BSD\work>vax780 install.ini

VAX780 simulator V3.8-0
RQ: creating new file
1.txt> set rq1 dis
Command not allowed
loading ra(0,0)boot
Boot
: ra(0,0)vmunix
199488+56036+51360 start 0x11a0
4.2 BSD UNIX #9: Wed Nov 2 16:00:29 PST 1983
real mem  = 8384512
avail mem = 7073792
using 102 buffers containing 835584 bytes of memory
mcr0 at tr1
mcr1 at tr2
uba0 at tr3
hk0 at uba0 csr 177440 vec 210, ipl 15
rk0 at hk0 slave 0
rk1 at hk0 slave 1
uda0 at uba0 csr 172150 vec 774, ipl 15
ra0 at uda0 slave 0
ra1 at uda0 slave 1
zs0 at uba0 csr 172520 vec 224, ipl 15
ts0 at zs0 slave 0
dz0 at uba0 csr 160100 vec 300, ipl 15
dz1 at uba0 csr 160110 vec 310, ipl 15
dz2 at uba0 csr 160120 vec 320, ipl 15
dz3 at uba0 csr 160130 vec 330, ipl 15
root on ra0
WARNING: clock gained 94 days -- CHECK AND RESET THE DATE!
WARNING: should run interleaved swap with >= 2Mb
erase ^?, kill ^U, intr ^C
#
```

### 恢复rootdump

现在我们正在rq0磁盘上的miniroot上运行。为了将系统从磁带镜像安装到虚拟机的磁盘上，我们需要运行磁带中的xtr程序以恢复rootdump（知识水平不足，这部分不太理解）：

```
# cd /dev
# ./MAKEDEV ra1
# cd /
# disk=ra1 type=ra81 tape=ts xtr
```

执行结果如下：

```
erase ^?, kill ^U, intr ^C
# cd /dev
# ./MAKEDEV ra1
# cd /
# disk=ra1 type=ra81 tape=ts xtr
Build root file system
Warning: 538 sector(s) in last cylinder unallocated
/dev/rra1a:     15884 sectors in 23 cylinders of 14 tracks, 51 se
        8.1Mb in 2 cyl groups (16 c/g, 5.85Mb/g, 1856 i/g)
super-block backups (for fsck -b#) at:
 32, 11520,
Check the file system
** /dev/rra1a
** Last Mounted on
** Phase 1 - Check Blocks and Sizes
** Phase 2 - Check Pathnames
** Phase 3 - Check Connectivity
** Phase 4 - Check Reference Counts
** Phase 5 - Check Cyl groups
2 files, 9 used, 7420 free (20 frags, 925 blocks)
Rewind tape
Restore the dump image of the root
Warning: ./lost+found: File exists
** /dev/rra1a
** Last Mounted on /a
** Phase 1 - Check Blocks and Sizes
** Phase 2 - Check Pathnames
** Phase 3 - Check Connectivity
** Phase 4 - Check Reference Counts
** Phase 5 - Check Cyl groups
313 files, 3568 used, 3861 free (21 frags, 480 blocks)
Root filesystem extracted

If this is a 780, update floppy
If this is a 730, update the cassette
#
```

在此之后，执行几次sync以保证数据同步写入磁盘（是这样吗？），然后按CTRL+E退出虚拟机并关闭simh：

```
If this is a 730, update the cassette
# sync
# sync
# sync

Simulation stopped, PC: 80001620 (FFS #0,#20,8003ED44,R0)
sim> q
Goodbye

C:\4.2BSD\work>
```

## 第二阶段

现在系统磁盘已经准备好了，我们可以使用一个新的配置文件 **boot.ini** 来启动虚拟机。（也可以[直接下载](files/rl/rogue/4.2BSD/boot.ini)）

```
set rq0 ra81
att rq0 rq.dsk
set rq1 dis
set rq2 dis
set rq3 dis
set rp dis
set lpt dis
set rl dis
set tq dis
set tu dis
att ts 42.tap
set tti 7b
set tto 7b
load -o boot42 0
d r10 9
d r11 0
run 2
```

### 启动虚拟机

使用 **boot.ini** 启动虚拟机：

```
C:\4.2BSD\work>vax780.exe boot.ini

VAX780 simulator V3.8-0
TS: creating new file
loading ra(0,0)boot
Boot
: ra(0,0)vmunix
199488+56036+51360 start 0x11a0
4.2 BSD UNIX #9: Wed Nov 2 16:00:29 PST 1983
real mem  = 8384512
avail mem = 7073792
using 102 buffers containing 835584 bytes of memory
mcr0 at tr1
mcr1 at tr2
uba0 at tr3
hk0 at uba0 csr 177440 vec 210, ipl 15
rk0 at hk0 slave 0
rk1 at hk0 slave 1
uda0 at uba0 csr 172150 vec 774, ipl 15
ra0 at uda0 slave 0
ra1 at uda0 slave 1
zs0 at uba0 csr 172520 vec 224, ipl 15
ts0 at zs0 slave 0
dz0 at uba0 csr 160100 vec 300, ipl 15
dz1 at uba0 csr 160110 vec 310, ipl 15
dz2 at uba0 csr 160120 vec 320, ipl 15
dz3 at uba0 csr 160130 vec 330, ipl 15
root on ra0
WARNING: should run interleaved swap with >= 2Mb
Automatic reboot in progress...
Mon Feb  6 05:05:49 PST 1984
Can't open checklist file: /etc/fstab
Automatic reboot failed... help!
erase ^?, kill ^U, intr ^C
#
```

### 准备磁盘

配置硬件设备（这里也不太明白）：

```
# disk=ra
# name=ra0h;type=ra81
# cd /dev
# ./MAKEDEV ts0;sync
# cd /
# newfs $name $type
```

执行结果如下：

```
# disk=ra
# name=ra0h;type=ra81
# cd /dev
# ./MAKEDEV ts0;sync
# cd /
# newfs $name $type
Warning: 28 sector(s) in last cylinder unallocated
/dev/rra0h:     759668 sectors in 1064 cylinders of 14 tracks, 51 sectors
        389.0Mb in 67 cyl groups (16 c/g, 5.85Mb/g, 2048 i/g)
super-block backups (for fsck -b#) at:
 32, 11512, 22992, 34472, 45952, 57432, 68912, 80392, 91872, 103352,
 114832, 126312, 137792, 149272, 160752, 172232, 182816, 194296, 205776, 217256,
 228736, 240216, 251696, 263176, 274656, 286136, 297616, 309096, 320576, 332056,
 343536, 355016, 365600, 377080, 388560, 400040, 411520, 423000, 434480, 445960,
 457440, 468920, 480400, 491880, 503360, 514840, 526320, 537800, 548384, 559864,
 571344, 582824, 594304, 605784, 617264, 628744, 640224, 651704, 663184, 674664,
 686144, 697624, 709104, 720584, 731168, 742648, 754128,
#
```

### 恢复usr分区

现在usr分区还没有格式化。我们挂载并重建usr分区，然后再将其卸载，运行 `fsck` 以确保执行正确。

```
# mount /dev/$name /usr
# cd /usr
# mkdir sys
# cd sys
# mt rew
# mt fsf 3
# tar xpbf 20 /dev/rmt12
# cd ..
# mt fsf
# tar xpbf 20 /dev/rmt12
# cd /
# chmod 755 / /usr /usr/sys
# rm -rf sys
# ln -s /usr/sys sys
# umount /dev/$name
# fsck /dev/r$name
```

执行结果如下：

```
# chmod 755 / /usr /usr/sys
# rm -rf sys
# ln -s /usr/sys sys
# umount /dev/$name
# fsck /dev/r$name
** /dev/rra0h
** Last Mounted on /usr
** Phase 1 - Check Blocks and Sizes
** Phase 2 - Check Pathnames
** Phase 3 - Check Connectivity
** Phase 4 - Check Reference Counts
** Phase 5 - Check Cyl groups
3735 files, 25550 used, 336310 free (166 frags, 84036 blocks)
#
```

### 配置fstab

现在创建fstab并格式化home分区，然后我们就可以重启虚拟机、进入多用户模式了：

```
# cd /etc
# cp fstab.ra81 fstab
# newfs ra0g ra81
# sync
# reboot
```

执行结果如下：

```
# cd /etc
# cp fstab.ra81 fstab
# newfs ra0g ra81
Warning: 30 sector(s) in last cylinder unallocated
/dev/rra0g:     82080 sectors in 115 cylinders of 14 tracks, 51 sectors
        42.0Mb in 8 cyl groups (16 c/g, 5.85Mb/g, 2048 i/g)
super-block backups (for fsck -b#) at:
 32, 11512, 22992, 34472, 45952, 57432, 68912, 80392,
# sync
# reboot
syncing disks... done

Reboot requested, PC: 80021716 (ADDL2 #8,SP)
sim> q
Goodbye
```

## 多用户模式！

### 启动虚拟机

再次使用 **boot.ini** 启动vax780.exe，我们就可以以多用户模式启动4.2 BSD了！可以使用root用户登录，默认无密码。由于系统第一次启动时会自动执行 `fsck` 指令，可能需要等待一段时间（与宿主机性能有关）。

```
C:\4.2BSD\work>vax780.exe boot.ini

VAX780 simulator V3.8-0
loading ra(0,0)boot
Boot
: ra(0,0)vmunix
199488+56036+51360 start 0x11a0
4.2 BSD UNIX #9: Wed Nov 2 16:00:29 PST 1983
real mem  = 8384512
avail mem = 7073792
using 102 buffers containing 835584 bytes of memory
mcr0 at tr1
mcr1 at tr2
uba0 at tr3
hk0 at uba0 csr 177440 vec 210, ipl 15
rk0 at hk0 slave 0
rk1 at hk0 slave 1
uda0 at uba0 csr 172150 vec 774, ipl 15
ra0 at uda0 slave 0
ra1 at uda0 slave 1
zs0 at uba0 csr 172520 vec 224, ipl 15
ts0 at zs0 slave 0
dz0 at uba0 csr 160100 vec 300, ipl 15
dz1 at uba0 csr 160110 vec 310, ipl 15
dz2 at uba0 csr 160120 vec 320, ipl 15
dz3 at uba0 csr 160130 vec 330, ipl 15
root on ra0
WARNING: should run interleaved swap with >= 2Mb
Automatic reboot in progress...
Mon Feb  6 05:21:02 PST 1984
/dev/ra0a: 326 files, 3569 used, 3860 free (20 frags, 480 blocks)
/dev/rra0h: 3735 files, 25550 used, 336310 free (166 frags, 84036 blocks)
/dev/rra0g: 2 files, 9 used, 77750 free (14 frags, 9717 blocks)
Mon Feb  6 05:21:15 PST 1984
check quotas: done.
local daemons: routed telnetd ftpd talkd syslog sendmail.
preserving editor files
clearing /tmp
standard daemons: update cron accounting mail    Mon Feb 6 05:21:17 PST 1984

 printer.
starting network: rshd rexecd rlogind rwhod.
Mon Feb  6 05:21:18 PST 1984


4.2 BSD UNIX (myname)

login:
```

现在就可以直接用root用户登录了。

```
4.2 BSD UNIX (myname)

login: root
4.2 BSD UNIX #9: Wed Nov 2 16:00:29 PST 1983

Would you like to play a game?

You have mail.
Don't login as root, use su
myname#
```

### 一些常用配置

#### 修改系统hostname

安装盘中的hostname默认为myname（很怪），我们可以编辑/etc/rc.local文件修改它。

```
myname# vi /etc/rc.local
```

将/bin/hostname 后的myname改为自己想要的名字（我改成了bsd），重启后即可生效。

#### 添加用户

4.2 BSD还没有adduser指令，我们需要执行 `vipw` 指令打开密码文件手动添加。

```
bsd# vipw
```

打开后可以看到形如

```
rogue::35:31:&:/usr/guest/rogue:/bin/csh
```

的用户条目，其中各项的含义如下：

```
用户名:加密后的用户密码（为空代表无密码）:用户代码（应与现有条目不重复）:用户组代码（10代表管理员，20代表学生？31代表访客？）:用户个人信息（可不填，显示在finger指令中）:用户启动的默认路径:用户使用的shell（留空默认是/bin/sh，也可以是/bin/csh）
```

我们在文件末尾添加新行，将新用户的信息填好（密码留空），保存退出。（建议用户路径为/usr/guest/[用户名]）

然后我们创建对应的用户路径，并将其所有者改为新用户。

```
bsd# cd /usr/guest/
bsd# mkdir [路径名]
bsd# chown [用户名] [路径名]
```

然后重启系统，再次启动就可以用新用户登录了。

登录后可以执行 `passwd` 修改当前用户密码。

#### 修改shell配置文件

/bin/sh的配置文件为/.profile，/bin/csh的配置文件为/.cshrc。可以将用户使用的shell对应的配置文件复制到用户的启动路径里加以修改，语法和Linux类似。下面是我的/.cshrc文件：

```
alias mail Mail
set history=40
# directory stuff: cdpath/cd/back
set cdpath=(/a/wnj)
alias   cd      'set old=$cwd; chdir \!*'
alias   back    'set back=$old; set old=$cwd; cd $back; unset back; dirs'
# sccs stuff: sd/co/ci/allout/out/unedit
alias   sd      'sccs get -p \!* | diff - \!$'
alias   co      sccs get -e
alias   ci      sccs delget
alias   allout  "(cd ..; echo */SCCS/p.*|sed s/SCCS\\/p.//g)"
alias   out     "echo SCCS/p.*|sed s/SCCS\\/p.//g"
alias   info    sccs info
alias   unedit  sccs unedit
# spms stuff: chproject/cpd
alias   chproject 'eval `"chproject" -d \!*`'
alias   cpd     'eval `"pd" \!*`'
alias   z               suspend
alias   area    'grep \!* /usr/games/lib/quiz.k/areas'
alias   tel     'grep -i \!* /usr/bill/bin/telno'
alias   x       exit
alias   pd      pushd
alias   pd2     pushd +2
alias   pd3     pushd +3
alias   pd4     pushd +4
alias   j       jobs -l
alias   l       "echo \!*{*}"
set path=(/etc /usr/ucb /bin /usr/bin /usr/local /usr/hosts . /usr/new /usr/game
s)
if ($?prompt) then
        set prompt="`hostname | sed s/ucb//`# "
endif
echo "Type in 'rogue' to play rogue in 4.2 BSD."
echo "        'rogue [savefilename].save' to load savefile."
echo "__________ ________    ________ ____ ______________"
echo "\______   \\_____  \  /  _____/|    |   \_   _____/"
echo " |       _/ /   |   \/   \  ___|    |   /|    __)_ "
echo " |    |   \/    |    \    \_\  \    |  / |        \"
echo " |____|_  /\_______  /\______  /______/ /_______  /"
echo "        \/         \/        \/                 \/ "
echo ""
echo ""
echo ""
```

登录效果如下：

```
Last login: Tue Apr 24 04:49:10 on tty00
4.2 BSD UNIX #9: Wed Nov 2 16:00:29 PST 1983

Would you like to play a game?

You have mail.
Type in 'rogue' to play rogue in 4.2 BSD.
        'rogue [savefilename].save' to load savefile.
__________ ________    ________ ____ ______________
\______   \\_____  \  /  _____/|    |   \_   _____/
 |       _/ /   |   \/   \  ___|    |   /|    __)_
 |    |   \/    |    \    \_\  \    |  / |        \
 |____|_  /\_______  /\______  /______/ /_______  /
        \/         \/        \/                 \/

```

### 远程用户连接

在 **boot.ini** 中添加如下内容可以使我们的虚拟机在tcp端口8888开放telnet连接，允许8个远程用户同时登入。（需要添加在启动指令之前，否则无法生效；直接添加在文件开头都行）

```
set dz lines=8
set dz 7b
att dz -m 8888
```

建议使用putty或syncterm等远程连接终端。Windows自带的telnet效果非常糟糕，我使用的时候甚至不能刷新屏幕……

### 玩Rogue！

#### 开始新游戏

执行

```
bsd# /usr/games/rogue
```

如果和我一样将 `/usr/games` 添加到配置文件中的系统路径里，只需要执行

```
bsd# rogue
```

#### 从上次存档继续游戏

在存档文件（假设为rogue.save）所在路径执行

```
bsd# /usr/games/rogue rogue.save
```

或

```
bsd# rogue rogue.save
```

#### 这是Rogue，它也没失踪也没怎样，只是很可爱大家都来看看.jpg

```
                                   a) Some food
                                   b) +1 ring mail [protection 4] (being worn)
                                   c) A +1,+1 mace (weapon in hand)
                                   d) A +1,+0 short bow
                                   e) 33 +0,+0 arrows
                                   --Press space to continue--


                             --------------
                             |...........*|
                             |...S........+
                             |............|
                             +......@.....|
                             |............|
                             -----+--------








Level: 1  Gold: 0      Hp: 12(12)  Str: 16(16)  Arm: 4   Exp: 1/0
```

